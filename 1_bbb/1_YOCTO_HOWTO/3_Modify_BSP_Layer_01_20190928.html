

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ko" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ko" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BSP Layer 수정하기 #1 - Kernel Configuration 수정하기 &mdash; blog 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="색인" href="../../genindex.html" />
    <link rel="search" title="검색" href="../../search.html" />
    <link rel="next" title="Practice" href="../../2_practice/index.html" />
    <link rel="prev" title="Start Yocto - 새 Layer 만들고 추가하기" href="2_Add_a_New_Layer_20190830.html" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146838704-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146838704-1');
</script>




</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> blog
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../0_blog/index.html">About this blog</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Beaglebone Black</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../0_SPI_HOWTO/index.html">BBB SPI Howto</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">BBB Yocto Howto</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="0_Start_20190828.html">Start Yocto with Beaglebone Black</a></li>
<li class="toctree-l3"><a class="reference internal" href="1_Add_A_New_Recipe_20190829.html">Start Yocto - Add a New Recipe</a></li>
<li class="toctree-l3"><a class="reference internal" href="2_Add_a_New_Layer_20190830.html">Start Yocto - 새 Layer 만들고 추가하기</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">BSP Layer 수정하기 #1 - Kernel Configuration 수정하기</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#yocto-ti-bsp-layer-kernel-configuration">Yocto TI BSP Layer의 Kernel Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">디렉토리 생성</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kernel-config-fragment">Kernel Config Fragment 생성</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bbappend">bbappend 파일 추가</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">설정 확인</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">빌드 및 확인</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">정리</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../2_practice/index.html">Practice</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">blog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Beaglebone Black</a> &raquo;</li>
        
          <li><a href="index.html">BBB Yocto Howto</a> &raquo;</li>
        
      <li>BSP Layer 수정하기 #1 - Kernel Configuration 수정하기</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/1_bbb/1_YOCTO_HOWTO/3_Modify_BSP_Layer_01_20190928.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bsp-layer-1-kernel-configuration">
<h1>BSP Layer 수정하기 #1 - Kernel Configuration 수정하기<a class="headerlink" href="#bsp-layer-1-kernel-configuration" title="제목 주소">¶</a></h1>
<p>몇 개의 문서를 통해서 Yocto에서 BSP Layer를 어떻게 수정하는지 정리 해보고자 한다.  그 첫 번째 순서로, 이번 문서에서는 Linux kernel의 config 파일을 수정해서 적용하는 방법을 알아보자.</p>
<p>이번 문서에서 사용되는 예제는  <a class="reference external" href="2_Add_a_New_Layer_20190830.html">지난 문서</a>에 이어 작업하였다.</p>
<div class="section" id="yocto-ti-bsp-layer-kernel-configuration">
<h2>Yocto TI BSP Layer의 Kernel Configuration<a class="headerlink" href="#yocto-ti-bsp-layer-kernel-configuration" title="제목 주소">¶</a></h2>
<p>Yocto로 생성되는 이미지는 크게 Poky, BSP Layer, Application Layer 등으로 나눌 수 있다. 이 중 BSP Layer는 보통 타겟 머신의 CPU 제조사가 레퍼런스 보드에 맞게 배포한다. Beaglebone Black 용 BSP Layer도 TI 에서 배포한 BSP Layer를 사용한다.</p>
<p>그러나 타겟 보드가 수정되거나, 원하는 기능들을 켜거나 끄고 싶을 때에는 BSP Layer의 내용을 수정해야 한다. 한편, Yocto에서는 이미 존재하는 Layer를 직접 수정하는 것 보다는 .bbappend 파일 등을 통해 수정 할 내용들을 Override 하도록 권장하지만, BSP Layer는 보드/CPU 제조사에 따라 그 구현방식(소스코드 Fetch / Patching / Configuration 등)이 달라지기 때문에 .bbappend를 작성하기 전에 수정하고자 하는 부분이 BSP Layer에서 어떻게 구현되어 있는지를 먼저 확인해 볼 필요가 있다.</p>
<p>예를들어, Yocto에서 Linux Kernel Configuration을 위한 Task인 do_configure() Task는 Beaglebone Black의 meta-ti Layer에서는 <a class="reference external" href="http://git.yoctoproject.org/cgit/cgit.cgi/meta-ti/tree/recipes-kernel/linux/setup-defconfig.inc">meta-ti/recipes-kernel/linux/setup-defconfig.inc</a>에 다음과 같이 구현되어 있다.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>do_configure<span class="o">()</span> <span class="o">{</span>
    <span class="c1"># Always copy the defconfig file to .config to keep consistency</span>
    <span class="c1"># between the case where there is a real config and the in kernel</span>
    <span class="c1"># tree config</span>
    cp <span class="si">${</span><span class="nv">WORKDIR</span><span class="si">}</span>/defconfig <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config

    <span class="nb">echo</span> <span class="si">${</span><span class="nv">KERNEL_LOCALVERSION</span><span class="si">}</span> &gt; <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.scmversion
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">KERNEL_LOCALVERSION</span><span class="si">}</span> &gt; <span class="si">${</span><span class="nv">S</span><span class="si">}</span>/.scmversion

    <span class="c1"># Zero, when using &quot;tisdk&quot; configs, pass control to defconfig_builder</span>
    <span class="nv">config</span><span class="o">=</span><span class="sb">`</span>cat <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config <span class="p">|</span> grep use-tisdk-config <span class="p">|</span> cut -d<span class="o">=</span> -f2<span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$config</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="si">${</span><span class="nv">S</span><span class="si">}</span>/ti_config_fragments/defconfig_builder.sh -w <span class="si">${</span><span class="nv">S</span><span class="si">}</span> -t <span class="nv">$config</span>
        oe_runmake -C <span class="si">${</span><span class="nv">S</span><span class="si">}</span> <span class="nv">O</span><span class="o">=</span><span class="si">${</span><span class="nv">B</span><span class="si">}</span> <span class="s2">&quot;</span><span class="nv">$config</span><span class="s2">&quot;</span>_defconfig
    <span class="k">else</span>
        <span class="c1"># First, check if pointing to a combined config with config fragments</span>
        <span class="nv">config</span><span class="o">=</span><span class="sb">`</span>cat <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config <span class="p">|</span> grep use-combined-config <span class="p">|</span> cut -d<span class="o">=</span> -f2<span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$config</span><span class="s2">&quot;</span> <span class="o">]</span>
        <span class="k">then</span>
            cp <span class="si">${</span><span class="nv">S</span><span class="si">}</span>/<span class="nv">$config</span> <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config
        <span class="k">fi</span>

        <span class="c1"># Second, extract any config fragments listed in the defconfig</span>
        <span class="nv">config</span><span class="o">=</span><span class="sb">`</span>cat <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config <span class="p">|</span> grep config-fragment <span class="p">|</span> cut -d<span class="o">=</span> -f2<span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$config</span><span class="s2">&quot;</span> <span class="o">]</span>
        <span class="k">then</span>
            <span class="nv">configfrags</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="k">for</span> f in <span class="nv">$config</span>
            <span class="k">do</span>
                <span class="c1"># Check if the config fragment is available</span>
                <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="si">${</span><span class="nv">S</span><span class="si">}</span><span class="s2">/</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span>
                <span class="k">then</span>
                    <span class="nb">echo</span> <span class="s2">&quot;Could not find kernel config fragment </span><span class="nv">$f</span><span class="s2">&quot;</span>
                    <span class="nb">exit</span> <span class="m">1</span>
                <span class="k">else</span>
                    <span class="c1"># Sanitize config fragment files to be relative to sources</span>
                    <span class="nv">configfrags</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$configfrags</span><span class="s2"> </span><span class="si">${</span><span class="nv">S</span><span class="si">}</span><span class="s2">/</span><span class="nv">$f</span><span class="s2">&quot;</span>
                <span class="k">fi</span>
            <span class="k">done</span>
        <span class="k">fi</span>

        <span class="c1"># Third, check if pointing to a known in kernel defconfig</span>
        <span class="nv">config</span><span class="o">=</span><span class="sb">`</span>cat <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config <span class="p">|</span> grep use-kernel-config <span class="p">|</span> cut -d<span class="o">=</span> -f2<span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$config</span><span class="s2">&quot;</span> <span class="o">]</span>
        <span class="k">then</span>
            oe_runmake -C <span class="si">${</span><span class="nv">S</span><span class="si">}</span> <span class="nv">O</span><span class="o">=</span><span class="si">${</span><span class="nv">B</span><span class="si">}</span> <span class="nv">$config</span>
        <span class="k">else</span>
            yes <span class="s1">&#39;&#39;</span> <span class="p">|</span> oe_runmake -C <span class="si">${</span><span class="nv">S</span><span class="si">}</span> <span class="nv">O</span><span class="o">=</span><span class="si">${</span><span class="nv">B</span><span class="si">}</span> oldconfig
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Fourth, handle config fragments specified in the recipe</span>
    <span class="c1"># The assumption is that the config fragment will be specified with the absolute path.</span>
    <span class="c1"># E.g. ${WORKDIR}/config1.cfg or ${S}/config2.cfg</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">KERNEL_CONFIG_FRAGMENTS</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="k">for</span> f in <span class="si">${</span><span class="nv">KERNEL_CONFIG_FRAGMENTS</span><span class="si">}</span>
        <span class="k">do</span>
            <span class="c1"># Check if the config fragment is available</span>
            <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2">&quot;</span> <span class="o">]</span>
            <span class="k">then</span>
                <span class="nb">echo</span> <span class="s2">&quot;Could not find kernel config fragment </span><span class="nv">$f</span><span class="s2">&quot;</span>
                <span class="nb">exit</span> <span class="m">1</span>
            <span class="k">fi</span>
        <span class="k">done</span>
    <span class="k">fi</span>

    <span class="c1"># Now that all the fragments are located merge them</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">KERNEL_CONFIG_FRAGMENTS</span><span class="si">}</span><span class="s2">&quot;</span> -o -n <span class="s2">&quot;</span><span class="nv">$configfrags</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="o">(</span> <span class="nb">cd</span> <span class="si">${</span><span class="nv">WORKDIR</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="si">${</span><span class="nv">S</span><span class="si">}</span>/scripts/kconfig/merge_config.sh -m -r -O <span class="si">${</span><span class="nv">B</span><span class="si">}</span> <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config <span class="nv">$configfrags</span> <span class="si">${</span><span class="nv">KERNEL_CONFIG_FRAGMENTS</span><span class="si">}</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">)</span>
        yes <span class="s1">&#39;&#39;</span> <span class="p">|</span> oe_runmake -C <span class="si">${</span><span class="nv">S</span><span class="si">}</span> <span class="nv">O</span><span class="o">=</span><span class="si">${</span><span class="nv">B</span><span class="si">}</span> oldconfig
    <span class="k">fi</span>
<span class="o">}</span>
</pre></div>
</div>
<p>특히 다음과 같이 가장 마지막에는 <em>KERNEL_CONFIG_FRGMENT</em> 환경변수에서 Kernel Configuration Fragment 파일들을 가져와 Merge 하는 작업을 거쳐 최종적인 .config 파일을 생성해 낸다.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Now that all the fragments are located merge them</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">KERNEL_CONFIG_FRAGMENTS</span><span class="si">}</span><span class="s2">&quot;</span> -o -n <span class="s2">&quot;</span><span class="nv">$configfrags</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="o">(</span> <span class="nb">cd</span> <span class="si">${</span><span class="nv">WORKDIR</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="si">${</span><span class="nv">S</span><span class="si">}</span>/scripts/kconfig/merge_config.sh -m -r -O <span class="si">${</span><span class="nv">B</span><span class="si">}</span> <span class="si">${</span><span class="nv">B</span><span class="si">}</span>/.config <span class="nv">$configfrags</span> <span class="si">${</span><span class="nv">KERNEL_CONFIG_FRAGMENTS</span><span class="si">}</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> <span class="o">)</span>
        yes <span class="s1">&#39;&#39;</span> <span class="p">|</span> oe_runmake -C <span class="si">${</span><span class="nv">S</span><span class="si">}</span> <span class="nv">O</span><span class="o">=</span><span class="si">${</span><span class="nv">B</span><span class="si">}</span> oldconfig
    <span class="k">fi</span>
</pre></div>
</div>
<p><a class="reference external" href="https://www.yoctoproject.org/docs/latest/kernel-dev/kernel-dev.html#creating-config-fragments"><em>Kernel Config Fragment</em></a>  파일은 Yocto에서 Kernel Configuration에 적용할 수 있는 패치와 비슷한 형태의 파일이다.  이를 통해 각 모듈 별 개발자들은 자신들이 원하는 옵션들만 모아서 Kernel Config 파일들을 만들어 낼 수 있으며, 위 do_configure Task는 이를 모아서 하나의 .config 파일로 생성해 낸다.</p>
<p>즉, 우리가 BSP Layer를 수정해야 할 일이 생기면 제조사가 배포한 BSP를 수정 할 필요 없이 다음과 같은 순서로 Linux Kernel (Configuration)의 수정이 가능하다.</p>
<ol class="simple">
<li>나만의 Layer를 추가한다. (예 : meta-mylayer)</li>
<li>Linux Kernel Recipe를 변경하기 위한 적절한 디렉토리 구조를 생성한다. (예 : meta-mylayer/recipe-kernel/linux)</li>
<li>수정할 Linux Kernel의 Recipe(.bb) 에 대한 .bbappend 파일을 적절한 생성한다.(예 : linux-ti-staging_4.14.bbappend)</li>
<li>필요한 파일들(소스코드 / 패치 / Kernel Config Fragment 등)을 적절히 배치한다. (예 : disable_cpu_trig.cfg)</li>
</ol>
<p>이번 문서에는 <a class="reference external" href="2_Add_a_New_Layer_20190830.html">지난 문서</a>의 예제에서 생성한 meta-mylayer Layer에 recipe-kernel이라는 디렉토리를 생성하여 작업하였다. 전체적인 파일 구조는 다음과 같으며, 하나 하나 자세히 알아보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ yocto-labs tree meta-mylayer                            
meta-mylayer
├── COPYING.MIT
├── README
├── conf
│   └── layer.conf
├── recipes-apps
│   └── ninvaders
│       ├── ninvaders.inc
│       └── ninvaders_0.1.1.bb
└── recipes-kernel
    └── linux
        ├── files
        │   └── disable_cpu_trig.cfg
        ├── linux-ti-staging_4.14.bbappend

<span class="m">6</span> directories, <span class="m">7</span> files
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>디렉토리 생성<a class="headerlink" href="#id1" title="제목 주소">¶</a></h2>
<p>우선 파일들을 생성하기 위한 디렉토리 구조를 잡아보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$HOME</span>/yocto-labs/meta-mylayer
$ mkdir -p recipes-kernel/linux/files
</pre></div>
</div>
</div>
<div class="section" id="kernel-config-fragment">
<h2>Kernel Config Fragment 생성<a class="headerlink" href="#kernel-config-fragment" title="제목 주소">¶</a></h2>
<p>다음으로, files 디렉토리에 Kernel Config Fragment 파일을 생성해 보자.
이번 예제에서는 BBB의 LED 를 지속적으로 깜빡이게 하는 CPU LED Trigger 드라이버를 제거하도록 설정할 것이다.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> recipes-kernel/linux/files
$ vi disable_cpu_trig.cfg 
</pre></div>
</div>
<p>disable_cpu_trig.cfg 파일의 내용은 다음과 같다.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cat disable_cpu_trig.cfg 
<span class="c1"># CONFIG_LEDS_TRIGGER_CPU is not set </span>
</pre></div>
</div>
</div>
<div class="section" id="bbappend">
<h2>bbappend 파일 추가<a class="headerlink" href="#bbappend" title="제목 주소">¶</a></h2>
<p>다음으로, 생성한 <em>disable_cpu_trig.cfg</em>  파일이 빌드 시에 포함되도록 Recipe를 수정할 것이다. 단, 직접 meta-ti BSP Layer의 Linux Kernel Recipe를 변경하는 것이 아니라 .bbappend 파일을 이용해서 우리에게 필요한 부분만 추가가 되도록 해 보자.</p>
<p>우선, bbappend 파일을 생성하기 위해서는 우리가 수정하고자 하는 Linux Kernel Recipe의 파일 명을 알아내어야 한다. 이를 위해 우리가 빌드 시 설정하는 MACHINE 환경 변수의 값인 beaglebone 에 대한 설정을 확인해 보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$HOME</span>/yocto-labs/meta-mylayer
$ cat meta-ti/conf/machine/beaglebone.conf
<span class="c1">#@TYPE: Machine</span>
<span class="c1">#@NAME: BeagleBone machine</span>
<span class="c1">#@DESCRIPTION: Machine configuration for the http://beagleboard.org/bone board </span>

require conf/machine/include/ti33x.inc
require conf/machine/include/beaglebone.inc

<span class="c1">#이하 생략</span>
</pre></div>
</div>
<p>이 파일은 <em>ti33x.inc</em> 파일과 <em>beaglebone.inc</em> 파일을 참조하고 있다. 먼저 <em>ti33x.inc</em>파일을 열어보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>➜  yocto-labs cat meta-ti/conf/machine/include/ti33x.inc 
<span class="c1"># 생략</span>

<span class="c1"># Default providers, may need to override for specific machines</span>
PREFERRED_PROVIDER_virtual/kernel <span class="o">=</span> <span class="s2">&quot;linux-ti-staging&quot;</span>
<span class="c1"># 이하 생략</span>
</pre></div>
</div>
<p>위와 같이 PREFERRED_PROVIDER_virtual/kernel 환경번수를 통해 <em>linux-ti-staging</em> 이라는 패키지가 Linux Kernel 빌드에 사용되도록 지정되어 있는 것을 확인 할 수 있다. 이제 <em>linux-ti-staging</em> 패키지의 Recipe를 찾아보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ find meta-ti -name <span class="s2">&quot;linux-ti-staging*.bb*&quot;</span>
meta-ti/recipes-kernel/linux/linux-ti-staging_4.14.bb
meta-ti/recipes-kernel/linux/linux-ti-staging-systest_4.14.bb
meta-ti/recipes-kernel/linux/linux-ti-staging-rt_4.14.bb
</pre></div>
</div>
<p>위와 같이 linux-ti-staging_4.14.bb 파일이 우리가 확장하고자 하는 Linux Kernel의 Recipe임을 알 수 있다. 이제 meta-mylayer에 이에 대한 bbappend 파일을 생성해 보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi meta-mylayer/recipes-kernel/linux/linux-ti-staging_4.14.bbappend
</pre></div>
</div>
<p>linux-ti-staging_4.14.bbappend 파일의 내용은 다음과 같다.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>FILESEXTRAPATHS_prepend :<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">THISDIR</span><span class="si">}</span><span class="s2">/files:&quot;</span>
<span class="nv">SRC_URI</span> <span class="o">+=</span> <span class="s2">&quot;file://disable_cpu_trig.cfg&quot;</span>
<span class="nv">KERNEL_CONFIG_FRAGMENTS</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKDIR</span><span class="si">}</span><span class="s2">/disable_cpu_trig.cfg&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li>Line #1 : disable_cpu_trig.cfg 파일이 저장되어 있는 files 디렉토리의 경로는 FILESEXTRAPATHS 변수에 추가한다.</li>
<li>Line #2 : 참조 할 소스코드들이 나열되어 있는 SRC_URI 환경변수에 disable_cpu_trig.cfg 파일을 추가한다.</li>
<li>Line #3 : KERNEL_CONFIG_FRAGMENTS  환경변수에 disable_cpu_trig.cfg 파일을 추가하여 빌드 시에 disable_cpu_trig.cfg 파일이 반영될 수 있도록 한다.</li>
</ul>
</div>
<div class="section" id="id2">
<h2>설정 확인<a class="headerlink" href="#id2" title="제목 주소">¶</a></h2>
<p>이제 빌드 할 모든 준비가 끝났다. 그러나 최종 패키지를 만들기 전에 menuconfig 를 통해 설정한 내용이 제대로 적용 되었는지 확인해 보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> <span class="nv">MACHINE</span><span class="o">=</span>beaglebone bitbake virtual/kernel -c cleansstate <span class="o">&amp;&amp;</span> <span class="se">\</span>
 <span class="nv">MACHINE</span><span class="o">=</span>beaglebone bitbake virtual/kernel -c menuconfig
</pre></div>
</div>
<p>위 명령을 입력하고 나면 cleansstate Task가 기존 작업 내용들을 정리한 후 새 창으로 menuconfig 화면이 나타날것이다.</p>
<p>여기서 Device Drivers/LED Support/LED Trigger support/**LED CPU Trigger ** 항목이 Disabled 되어 있어야 한다.</p>
</div>
<div class="section" id="id3">
<h2>빌드 및 확인<a class="headerlink" href="#id3" title="제목 주소">¶</a></h2>
<p>정상적으로 원하는 항목들이 적용된 것 까지 확인 되었으면 빌드 한 후 테스트 해 보자.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">MACHINE</span><span class="o">=</span>beaglebone bitbake core-image-minimal
</pre></div>
</div>
<p>빌드 후 만들어진 이미지를 보드에 올려 테스트 해 보면 CPU Trigger 드라이버를 제거했기 때문에 이와 관련된 LED 2와 3이 반짝이지 않는 것을 확인 할 수 있다.</p>
</div>
<div class="section" id="id4">
<h2>정리<a class="headerlink" href="#id4" title="제목 주소">¶</a></h2>
<p>이번 글에서는 Yocto에서 BSP Layer를 어떻게 수정하는지 알아보았다. Yocto에서는 기존에 존재하는 Layer를 바로 수정하는것을 권장하지 않기 때문에 새로 추가한 나만의 Layer에 .bbappend 파일을 추가함으로써 간접적으로 수정이 이루어지도록 해야 한다.</p>
<p>그 예제로 Linux Kernel Configuration을 수정하는 예제를 만들어 보았다. 이를 위해 CPU LED Trigger 드라이버를 제거하는 Kernel Configuration Fragment를 만들었고, 이를 적용하기 위해 Linux Kernel의 Recipe를 확장하는 bbappend 파일을 추가하여 만든 파일이 빌드에 적용될 수 있도록 하였다.</p>
<p>다음 문서에서는 이번 글을 확장하여 Linux Kernel의 패치를 만들어 적용해 보는 방법을 알아볼 계획이다.</p>
</div>
</div>


           </div>
           
           <div class="articleComments">
            
<script src="https://utteranc.es/client.js"
        repo="hcyang1012/blog-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../2_practice/index.html" class="btn btn-neutral float-right" title="Practice" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="2_Add_a_New_Layer_20190830.html" class="btn btn-neutral float-left" title="Start Yocto - 새 Layer 만들고 추가하기" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Heecheol Yang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  

<script>
 
</script>


</body>
</html>